<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
{% load static %}
    <link rel="stylesheet" href="{% static 'css/exlchi.css' %}" type="text/css">
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <link rel="icon" href="{% static 'images/favicon.ico' %}">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'font/css/font-awesome.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <title>Search Results</title>
    <style type="text/css">
        #menu li a {
	color: #afd9ee;
	display: block;
	font-size: 14px;
	line-height: 20px;
	padding: 6px 12px;
	margin: 8px 8px;
	vertical-align: middle;
	text-decoration: none;
}

#menu li a:hover {
	background: -webkit-gradient(linear, center top, center bottom, from(#ededed), to(#fff));
	background-image: linear-gradient(#ededed, #fff);
	border-radius: 12px;
	box-shadow: inset 0px 0px 1px 1px rgba(0,0,0,0.1);
	color: #222;
}
    </style>
</head>
{% load i18n %}
<body id="body">

<nav class="navbar navbar-default navbar-fixed-top" role="navigation" style="background-color: #003366;height:50px;">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand">Bibliosoft</a>
        </div>
        <div>
            <ul class="nav navbar-nav navbar-right" id="menu" style="position:absolut; left:0px; top:0px">
                <li><a href="{% url 'index' %}"><span class="glyphicon glyphicon-home"></span> {% trans '返回首页' %}</a></li>
                <li><a href="/user_message/"><span class="h5"></span>{% trans '个人中心' %}</a></li>
            </ul>
        </div>
        <div class="btn-group navbar-btn" data-toggle="buttons">
                <form action="{% url 'set_language' %}" method="post" id="lang">
                {% csrf_token %}
                <input type="hidden" id="lang_s" name="language" value="en">
                <input name="next" type="hidden" value="{{ redirect_to }}"/>
                <label class="btn btn-primary active"  onclick="test('zh-hans')">
                    中文
                </label>
                <label class="btn btn-primary" onclick="test('en')">
                    English
                </label>
                </form>
        </div>
    </div>
</nav>


<div id="search" style="margin-top:40px;" align="center">
    <img width="160px" src="/static/images/book_logo.png" />
    <table id="search" >
        <tbody>
            <tr>
                <td id="col2">
                        <form name="cclform" >
                            <input style="width: 410px;visibility: hidden"  >
                                <select name="find_code" id="find_code">
                                    <option value="all_type">{% trans '所有字段' %}</option>
    {#                                <option value="author">作者</option>#}
    {#                                <option value="isbn">ISBN</option>#}
                                    <option value="history">{% trans '历史' %}</option>
                                    <option value="literature">{% trans '文学' %}</option>
                                    <option value="philosophy">{% trans '哲学' %}</option>
                                    <option value="computer">{% trans '计算机' %}</option>
                                </select>
                            <input autocomplete="off" style="width:30%" name="request" value="{{ search_text }}" id="find_text"> &nbsp;
                            <span id="refine"></span>
                            <input id="lookup" type="button" value="{% trans '检索' %}" onclick="result_search()">
                            </form>
                </td>
            </tr>
        </tbody>
    </table>

<br/>
</div>
<hr class="itemsep" size="20">
<div id="result">
{% for book in book_list %}
    <table class="items" style="margin:5px 0">
     <tbody>
          <tr>
                <td class="col1" valign="top"></td>
                <td class="cover" valign="top"><img style="border: medium none;" src="{{ book.image_url }}"/></td>
                <td class="col2">
                    <div class="itemtitle">{{ book.book_name }}</div>
                    <table border="0" cellpadding="0" cellspacing="0">
                        <tbody>
                              <tr>
                                 <td class="label1">{% trans '作者' %}：</td>
                                 <td class="content" valign="top">{{ book.author }}</td>
                              </tr>
                              <tr>
                               <td class="label1">{% trans '索书号' %}：</td>
                               <td class="content isbn id_{{ forloop.counter }}"  valign="top">{{ book.isbn }}</td>
                              </tr>
                              <tr>
                                  <td class="label1">{% trans '地点' %}：</td>
                                  <td class="content" valign="top">{{ book.place }}</td>
                              </tr>
                              <tr>
                                  <td class="label1">{% trans '类型' %}：</td>
                                  <td class="content" valign="top">{{ book.type }}</td>
                              </tr>
                              <tr>
                                  <td class="label1">{% trans '价格' %}：</td>
                                  <td class="content" valign="top">{{ book.price }}</td>
                              </tr>
                              <tr>
                                  <td class="libs" colspan="2" align="left"><a href="">{% blocktrans %}馆藏复本:{% endblocktrans %}{{ book.total_num }},{% blocktrans %}可用复本:{% endblocktrans %}{{ book.available_num }}</a></td>
                              </tr>
                        </tbody>
                    </table>
                </td>
          {% if not administrator %}
              {% if book.available_num > 0 %}
                    <td align="center"><button id="{{ forloop.counter }}" class="button">{% trans '预约' %}</button></td>
                {% else %}
                    <td align="center"><button id="{{ forloop.counter }}" class="button" disabled="disabled">{% trans '无可预约数据' %}</button></td>
                {% endif %}
          {% endif %}
                <!--<td class="cover" valign="top" ></td>-->


          </tr>
     </tbody>
</table>
<hr class="itemsep" size="1">

{% endfor %}

</div>
<footer style="color: #000000;font-weight: 20px;font-size: .60em;font-style: italic;text-align: center;">
京 ICP备 09067229号   京公网安备 110105000296   版权所有 A14组
<br>
Copyright &copy;2018 Library
<br>
<a href="#">xiaoxiongxiong@xiongxiong.com</a>
</footer>
<script type="application/javascript">
    $("#body").on('click', '.button' ,function(){
        var id = $(this).attr("id");
        var class_selector = "id_"+ id;
        var isbn = document.getElementsByClassName(class_selector)[0].innerHTML;
        $.post('/reserve/api/',{"isbn":isbn}, function (result, statue) {
            if(result["result"]===false){
                alert("图书添加失败!\n错误信息: "+ result['msg']);
            }else {
                var this_button = document.getElementById(id);
                this_button.disabled  = true;
                this_button.innerText = "{% trans '预约成功' %}";
                if(result["update"] === true){
                    alert("该书已预约, 已更新预约时间!")
                }
            }
        })
    });
    function result_search() {
        var type_dic = {"computer":"计算机","literature":"哲学" ,
                         "philosophy": "哲学", "history":"历史",
                        "all_type":"全部",
                        };
            var find_code =  document.getElementById("find_code");
            var index = find_code.selectedIndex;
            var type = find_code.options[index].value;
            var find_text = $("#find_text").val();
            var get_data ={};
            get_data["book_type"] = type_dic[type];
            get_data["book_name"] = find_text;
            $.get('/search_book/api/',get_data, function (result, status) {
            if(result["result"]===false){
                alert("搜索失败!\n失败信息: "+ result["msg"])
            }
            else {
                var result_div = document.getElementById("result");
                result_div.innerHTML= result["html"];
            }
        }
        )
    }
</script>
<script>
    $.ajaxSetup({
    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
});
    $(document).ready(function () {
        $('#find_text').bind('keypress',function(event){
            if (event.keyCode == "13") {
               result_search();
            }
        })
    });
    function test(str){
        var li=document.getElementById("lang").getElementsByTagName("input");
        li[1].value=str;
        document.getElementById("lang").submit();
        //submit
    }
</script>
</body>
</html>